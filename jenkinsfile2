pipeline {
  agent any

  stages {
    stage('Git') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          echo 'Hello World'
          git credentialsId: 'tfs test', url: 'http://ankaraofis.basarsoft.com.tr:1515/tfs/SEML/geomarket_test/_git/geomarket_test'
        }
      }
    }

    stage('Clean and Build') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat "cd C:/ProgramData/Jenkins/.jenkins/workspace/GeoMarket"
          bat "mvn clean"
          bat "mvn compile"
          bat "mvn validate"
        }
      }
    }

    stage('Test') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat "cd C:/ProgramData/Jenkins/.jenkins/workspace/GeoMarket"
          bat 'mvn test surefire-report:report site'
        }
      }
    }

    stage('Report') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\GEOMARKET\\target\\site', reportFiles: 'surefire-report.html', reportName: 'HTML Report', reportTitles: ''])
          bat "cd C:/ProgramData/Jenkins/.jenkins/workspace/GeoMarket"
          bat "allure generate --clean -a"
        }
      }
    }

    stage('Mail') {
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat "cd C:/ProgramData/Jenkins/.jenkins/workspace/GeoMarket"
          bat "allure generate --clean -a"
          
          script {
            def summaryJson = readFile('allure-report/widgets/summary.json')
            def failureCount = summaryJson.statistic.failed
            def successCount = summaryJson.statistic.passed

            emailext body: '''$PROJECT_NAME - Build # $BUILD_NUMBER

            Hatalar: $failureCount
            Başarılı: $successCount

            GEOMARKET Test Raporu ${BUILD_URL}allure/ adresinden incelenebilir.
            Username: reportUser
            Password: Basar1''', subject: 'Test Report', to: 'mert.sen@basarsoft.com.tr, testteam@basarsoft.com.tr, huseyin.arslan@basarsoft.com.tr, sule.hasdeniz@basarsoft.com.tr, hakan.beyhan@basarsoft.com.tr, caglayan@basarsoft.com.tr'
          }
        }
      }
    }
  }
}
